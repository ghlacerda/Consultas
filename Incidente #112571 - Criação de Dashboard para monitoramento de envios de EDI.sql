--Indicar documentos que possuem comprovante de entrega integrado, porém sem integração com o cliente
SELECT 1 ORDEM,
        DOC.HANDLE,
	FILIAIS.NOME,
	CAST(DOC.NUMEROSDOCUMENTOS AS VARCHAR(100))NUMEROSDOCUMENTOS,
	DOC.NUMERO DOCUMENTO,
	DOC.DATAENTREGA,
	ANEXO.K_INTEGRADOCLIENTE INTEGRADO,
	ANEXO.K_DTINTEGRACAOCLIENTE DATAINTEGRACAO,
	ANEXO.ARQUIVO Arquivo,
	ANEXO.DESCRICAO,
	CASE
		WHEN ANEXO.K_INTEGRADOCLIENTE = 'S' THEN 'INTEGRADO'
	ELSE 'NÃO INTEGRADO'
	END AS TIPO
FROM GLGL_DOCUMENTOS DOC
INNER JOIN GLGL_DOCUMENTOANEXOS ANEXO ON ANEXO.DOCUMENTO = DOC.HANDLE and ANEXO.CLASSIFICACAO IN(497,1281) --COMPROVANTE DE ENTREGA E COMPROVANTE DE ENTREGA MOBILE
INNER JOIN FILIAIS ON FILIAIS.HANDLE = DOC.FILIAL
INNER JOIN GLCM_REGOPERACIONAIS REG ON DOC.REGOPERACIONAL = REG.HANDLE
INNER JOIN GN_PESSOAS P ON DOC.REMETENTE = P.HANDLE 
WHERE 1=1
AND ((DOC.TIPODOCUMENTO IN (2)) OR ((DOC.TIPODOCUMENTO = 6 AND DOC.TIPORPS IN (322))))
AND ANEXO.K_INTEGRADOCLIENTE = 'N'
AND REG.K_ARQUIVAMENTODIGITAL = 'S'
AND DOC.DATAENTREGA >= '2019-11-25'
AND DOC.DATAENTREGA < '2019-12-13'
AND P.CGCCPF LIKE '%71.673.990%'
AND NOT EXISTS (Select 1
					From GLGL_DOCUMENTOANEXOS DLA
				Where 1=1 
				AND DLA.K_INTEGRADOCLIENTE = 'S'
				--AND DLA.DOCUMENTO = 41218891
				AND DLA.DOCUMENTO = DOC.HANDLE 
				AND DLA.CLASSIFICACAO IN(497,1281))
UNION ALL
--* Alerta de arquivos recusados
SELECT 2 ORDEM,
        DOC.HANDLE,
	FILIAIS.NOME,
	CAST(DOC.NUMEROSDOCUMENTOS AS VARCHAR(100))NUMEROSDOCUMENTOS,
	DOC.NUMERO DOCUMENTO,
	DOC.DATAENTREGA,
	'' AS INTEGRADO,
	'' AS DATAINTEGRACAO,
	'' AS Arquivo,
	'' AS DESCRICAO,
	'RECUSADOS' AS TIPO
FROM GLGL_DOCUMENTOS DOC
--INNER JOIN GLGL_DOCUMENTOANEXOS ANEXO ON ANEXO.DOCUMENTO = DOC.HANDLE and ANEXO.CLASSIFICACAO IN(497,1281) --COMPROVANTE DE ENTREGA E COMPROVANTE DE ENTREGA MOBILE
INNER JOIN FILIAIS ON FILIAIS.HANDLE = DOC.FILIAL
INNER JOIN GLCM_REGOPERACIONAIS REG ON DOC.REGOPERACIONAL = REG.HANDLE
INNER JOIN GN_PESSOAS P ON DOC.REMETENTE = P.HANDLE 
WHERE 1=1
AND ((DOC.TIPODOCUMENTO IN (2)) OR ((DOC.TIPODOCUMENTO = 6 AND DOC.TIPORPS IN (322))))
--AND ANEXO.K_INTEGRADOCLIENTE = 'N'
AND REG.K_ARQUIVAMENTODIGITAL = 'S'
AND DOC.DATAENTREGA >= '2019-11-25'
AND DOC.DATAENTREGA < '2019-12-13'
--AND P.CGCCPF LIKE '%71.673.990%'
AND NOT EXISTS (Select 1
					From GLGL_DOCUMENTOANEXOS DLA
				Where 1=1 
				--AND DLA.K_INTEGRADOCLIENTE = 'S'
				AND DLA.DOCUMENTO = DOC.HANDLE 
				AND DLA.CLASSIFICACAO IN(497,1281))
AND DOC.DEVOLUCAO = 'N'

--* Documentos finalizados sem comprovante de entrega
SELECT 3 ORDEM,
        DOC.HANDLE,
	FILIAIS.NOME,
	CAST(DOC.NUMEROSDOCUMENTOS AS VARCHAR(100))NUMEROSDOCUMENTOS,
	DOC.NUMERO DOCUMENTO,
	DOC.DATAENTREGA,
	ANEXO.K_INTEGRADOCLIENTE INTEGRADO,
	ANEXO.K_DTINTEGRACAOCLIENTE DATAINTEGRACAO,
	ANEXO.ARQUIVO Arquivo,
	ANEXO.DESCRICAO,
	'DOC. ENTREGUE, SEM COMPROVANTE' AS TIPO
FROM GLGL_DOCUMENTOS DOC
INNER JOIN GLGL_DOCUMENTOANEXOS ANEXO ON ANEXO.DOCUMENTO = DOC.HANDLE 
INNER JOIN FILIAIS ON FILIAIS.HANDLE = DOC.FILIAL
INNER JOIN GLCM_REGOPERACIONAIS REG ON DOC.REGOPERACIONAL = REG.HANDLE
INNER JOIN GN_PESSOAS P ON DOC.REMETENTE = P.HANDLE 
WHERE 1=1
AND ((DOC.TIPODOCUMENTO IN (2)) OR ((DOC.TIPODOCUMENTO = 6 AND DOC.TIPORPS IN (322))))
--AND ANEXO.K_INTEGRADOCLIENTE = 'N'
--AND REG.K_ARQUIVAMENTODIGITAL = 'S'
AND DOC.DATAENTREGA >= '2019-11-25'
AND DOC.DATAENTREGA < '2019-12-13'
AND P.CGCCPF LIKE '%71.673.990%'
AND ANEXO.CLASSIFICACAO NOT IN(497,1281) --COMPROVANTE DE ENTREGA E COMPROVANTE DE ENTREGA MOBILE


--------------------------------------------------------------------------------------------------------------------------------------

declare @BeginDate DATE = '2019-12-01'
declare @EndDate DATE = '2019-12-11'

SELECT  distinct 
	    DOCCLI.NUMERO NUMERONF                                                     
	   ,DOCCLI.PEDIDO                                                              
	   ,DOCCLI.SERIE 
		--FL.NOME FILIALDOC             
	 --  ,FL.CGC                          
	   ,CASE DOC.TIPODOCUMENTO          
					WHEN 1 THEN 'CTRC'    
					WHEN 2 THEN 'CT-e'  
					WHEN 6 THEN 'RPS' 
		END as TIPODOC
		,TB3.NOME
		,DATEDIFF(MINUTE,K_DATAALTERACAO,GETDATE()) DIFERENCA
	 --  ,CASE WHEN CAST(LOG.DATA AS DATE) = '1899-12-30' THEN OCORREN.INCLUIDOEM ELSE LOG.DATA END  DATAOCORRENCIA
	 --  ,CASE WHEN MOTIV.ENTREGACONCLUIDA = 'S' THEN DOC.DATAENTREGA ELSE NULL END [DATAENTREGA]                  
	 --   ,CASE WHEN MOTIV.ENTREGACONCLUIDA = 'S'                                                                  
		--	THEN DATEDIFF(HOUR,OCORREN.INCLUIDOEM,                                                                  
		--		CASE WHEN CAST(LOG.DATA AS DATE) = '1899-12-30'                                                     
		--			THEN OCORREN.INCLUIDOEM ELSE LOG.DATA                                                           
		--			END )                                                                                           
		--ELSE NULL END [DIFERENCAOCORRENCIAENTREGAHORAS]                            
	  ,FLOCORRENCIA.NOME FILIALOCORREN 
	  ,OCORREN.EDIDATAHORAENVIO                                           
	 --  ,REPLACE(REPLACE(REPLACE(PESSOA.CGCCPF,'/',''), '.', ''), '-', '') as CGCCPF
	 --  ,DOCCLI.NUMERO NUMERONF                                                     
	 --  ,DOCCLI.PEDIDO                                                              
	 --  ,DOCCLI.SERIE                                                               
	--   ,CASE WHEN EXISTS (SELECT 1                                                 
	--			FROM GLOP_OCORRENCIAS A                                                                           
	--			JOIN GLOP_MOTIVOOCORRENCIAS B ON A.OCORRENCIA = B.HANDLE                                          
	--		       WHERE B.CODIGO = '60'                                                                          
	--			 AND A.NOTAFISCAL = DOCCLI.HANDLE                                                                 
	--			 AND A.ESTORNADO = 'N'                                                                            
	--			 AND A.PENDENCIA = 'N') AND MOTIV.CODIGO = '1' THEN '91' ELSE MOTIV.CODIGO END AS CODIGOOCORRENCIA
	--   ,ISNULL(MOTIV.K_DESCRICAOEDI, MOTIV.DESCRICAO) DESCRICAOOCORRENCIA                               
	--   ,CASE WHEN MOTIV.ENTREGACONCLUIDA = 'S' THEN DOC.RECEBIDOPOR ELSE NULL END RECEBIDOPOR           
	--   ,CASE WHEN MOTIV.ENTREGACONCLUIDA = 'S' THEN DOC.RECEBIDOPORPARENTESCO2 ELSE NULL END  PARENTESCO
 --,(SELECT TOP 1 NOME FROM                                                                             
	--		GLID_EXPARQUIVODOCUMENTOS ARQUIVODOCUMENTO                                                        
	--		LEFT JOIN GLID_EXPARQUIVOS ARQUIVO ON ARQUIVO.HANDLE = ARQUIVODOCUMENTO.ARQUIVO                   
	--		WHERE ARQUIVODOCUMENTO.NOTAFISCAL = DOCCLI.HANDLE AND ARQUIVODOCUMENTO.OCORRENCIA = OCORREN.HANDLE
	--		ORDER BY ARQUIVO.DATAGERACAO ASC) ARQUIVO                                                         
	--	,(SELECT TOP 1 ARQUIVO.DATAGERACAO FROM                                                            
	--		GLID_EXPARQUIVODOCUMENTOS ARQUIVODOCUMENTO                                                     
	--		LEFT JOIN GLID_EXPARQUIVOS ARQUIVO ON ARQUIVO.HANDLE = ARQUIVODOCUMENTO.ARQUIVO                
	--		WHERE ARQUIVODOCUMENTO.NOTAFISCAL = DOCCLI.HANDLE AND ARQUIVODOCUMENTO.OCORRENCIA = OCORREN.HANDLE 
	--		ORDER BY ARQUIVO.DATAGERACAO ASC) DATAGERACAO                                                      
	--    ,(SELECT  TOP 1 DATEDIFF(MINUTE,OCORREN.INCLUIDOEM,ARQUIVO.DATAGERACAO) FROM                     
	--		GLID_EXPARQUIVODOCUMENTOS ARQUIVODOCUMENTO                                                        
	--		LEFT JOIN GLID_EXPARQUIVOS ARQUIVO ON ARQUIVO.HANDLE = ARQUIVODOCUMENTO.ARQUIVO                   
	--		WHERE ARQUIVODOCUMENTO.NOTAFISCAL = DOCCLI.HANDLE AND ARQUIVODOCUMENTO.OCORRENCIA = OCORREN.HANDLE
	--		ORDER BY ARQUIVO.DATAGERACAO ASC) [DIFERENCAINSERCAOGERACAOMINUTOS]                         
FROM GLOP_OCORRENCIAS OCORREN                                                                      
LEFT  JOIN GLGL_DOCUMENTOS DOC ON DOC.HANDLE = OCORREN.DOCUMENTO                                   
LEFT JOIN GLGL_DOCUMENTOASSOCIADOS DA ON DA.DOCUMENTOLOGISTICA = DOC.HANDLE                        
LEFT JOIN GLGL_DOCUMENTOCLIENTES DOCCLI ON DOCCLI.HANDLE = OCORREN.NOTAFISCAL                      
INNER JOIN GN_PESSOAS PESSOA ON PESSOA.HANDLE = DOCCLI.REMETENTE                                   
INNER JOIN GLOP_MOTIVOOCORRENCIAS MOTIV ON MOTIV.HANDLE = OCORREN.OCORRENCIA                       
INNER JOIN GLCM_REGOPERACIONAIS REGOP ON REGOP.CONTRATO = DOCCLI.CONTRATO                          
LEFT JOIN GLCM_REGOPEDI TB1 ON REGOP.HANDLE = TB1.REGOPERACIONAL
LEFT JOIN Z_AGENDAMENTOS TB2 ON TB1.OEAGENDAMENTO = TB2.HANDLE
LEFT JOIN Z_AGENDAMENTOPARAMETROS TB3 ON TB2.HANDLE = TB3.AGENDAMENTO 
INNER JOIN FILIAIS FL ON FL.HANDLE = DOCCLI.FILIAL                                                 
INNER JOIN FILIAIS FLOCORRENCIA ON FLOCORRENCIA.HANDLE = OCORREN.FILIAL                            
LEFT JOIN GLOP_OCORRENCIALOGS LOG ON LOG.OCORRENCIA = OCORREN.HANDLE AND LOG.DESCRICAO = 'Inclusão'
WHERE 1=1 
AND DOCCLI.NUMERO IN (
23393976
,23427783
,23439989
,23440229
,23440871
,23440873
,23440876
,23456305
,23456307
,23456311
,23456312
,23456314
,23468397
,23468398
,23468399

)


AND (((MOTIV.ENVIAEDI = 'S' AND OCORREN.ENVIAEDIMANUAL = 'S')                                   
AND (CAST(OCORREN.K_DATAALTERACAO AS DATE) BETWEEN @BeginDate AND @EndDate))                   
OR ((OCORREN.ENVIAEDIMANUAL = 'S')                                                                 
AND (CAST(OCORREN.DATAENVIOEDIMANUAL AS DATE) BETWEEN @BeginDate AND @EndDate)))               
AND DOC.STATUS NOT IN (236,237)                                                                    
AND OCORREN.ESTORNADO = 'N'                                                                        
AND DOCCLI.PEDIDO IS NOT NULL                                                                                                                                      
--AND OCORREN.EDIDATAHORAENVIO IS NULL                                                             
AND dbo.BL_EDIDevolvidoOrigem(DOCCLI.HANDLE,MOTIV.HANDLE) = 1
--AND TB3.NOME = 'VERMELHO'